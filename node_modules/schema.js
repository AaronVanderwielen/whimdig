function initSchema(m) {
	// validation messages
	var valMsg = {
		required: '{PATH} is required!',
		enum: 'enum validator failed for path `{PATH}` with value `{VALUE}`'
	}

	// complexType
	var location = { type: [Number], index: '2dsphere', required: valMsg.required };

	// enums
	var intensityVariable = {
		values: 'start end'.split(' '),
		message: valMsg.enum
	};
	var privacy = {
		values: 'public private'.split(' '),
		message: valMsg.enum
	}
	var tagGlyph = {
		values: 'music beer cutlery dog playing_dices book gamepad soccer_ball birthday_cake film'.split(' '),
		message: valMsg.enum
	};

	var eventSchema = new m.Schema({
		name: { type: String, required: valMsg.required },
		loc: location,
		desc: { type: String, required: valMsg.required },
		start: { type: Date, required: valMsg.required },
		end: { type: Date, required: valMsg.required },
		privacy: { type: String, required: valMsg.required },
		intensity_variable: { type: String, enum: intensityVariable, required: valMsg.enum },
		messages: [{}],
		_created_by: { type: m.Schema.Types.ObjectId, ref: 'User' },
		_users: [{ type: m.Schema.Types.ObjectId, ref: 'User' }],
		_invited: [{ type: m.Schema.Types.ObjectId, ref: 'User' }],
		_tags: [{ type: m.Schema.Types.ObjectId, required: valMsg.required, ref: 'Tag' }],
		_place: { type: m.Schema.Types.ObjectId, required: valMsg.required, ref: 'Place' }
	});

	var placeSchema = new m.Schema({
		place_id: { type: String, required: valMsg.required },
		name: { type: String, required: valMsg.required },
		loc: location,
		vicinity: { type: String, required: valMsg.required }
	});

	var tagSchema = new m.Schema({
		glyph: { type: String, enum: tagGlyph, required: valMsg.required },
		label: { type: String, required: valMsg.required }
	});

	var userSchema = new m.Schema({
		facebook_id: { type: String, required: valMsg.required },
		first_name: String,
		last_name: String,
		admin: Boolean,
		last_login: Date,
		_friends: [{ type: m.Schema.Types.ObjectId, ref: 'User' }],
		_places: [{ type: m.Schema.Types.ObjectId, ref: 'Place' }],
		_mail: [{ type: m.Schema.Types.ObjectId, ref: 'Mail' }]
	});

	var mailSchema = new m.Schema({
		subject: String,
		messages: [{}],
		read_log: [], // user ids who've seen latest message
		last_modified: Date,
		_users: [{ type: m.Schema.Types.ObjectId, required: valMsg.required, ref: 'User' }],
	});

	eventSchema.pre('validate', function (next) {
		if (this.start <= new Date()) {
			this.invalidate('start', 'Start date must be later than now');
		}
		if (this.start > this.end) {
			this.invalidate('end', 'End date must come after start date');
		}
		if (this._tags.length === 0) {
			this.invalidate('_tags', 'Please select some event tags');
		}
		next();
	});

	var Event = m.model('Event', eventSchema);
	var Place = m.model('Place', placeSchema);
	var Tag = m.model('Tag', tagSchema);
	var User = m.model('User', userSchema);
	var Mail = m.model('Mail', mailSchema);

	return {
		event: Event,
		place: Place,
		tag: Tag,
		user: User,
		mail: Mail
	};
}

module.exports = function (mongoose) {
	var schema = initSchema(mongoose);
	return schema;
};